<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PlanPilot</title>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <!-- PlanPilot CSS -->
    <link rel="stylesheet" href="css/main.css">
    <link rel="stylesheet" href="css/components.css">
    <link rel="stylesheet" href="css/map.css">
    <link rel="stylesheet" href="css/responsive.css">
</head>
<body>
    <!-- Hamburger Menu Button -->
    <button class="hamburger-menu" id="hamburgerBtn" onclick="toggleSidebar()" aria-label="Toggle menu">
        <span></span>
        <span></span>
        <span></span>
    </button>
    
    <!-- Sidebar Backdrop for Mobile -->
    <div class="sidebar-backdrop" id="sidebarBackdrop" onclick="closeSidebar()"></div>
    
    <!-- Sidebar -->
    <div class="sidebar" id="sidebar">
        <div class="sidebar-fixed-header">
            <div class="sidebar-header">
                <div class="sidebar-header-logo" id="logoContainer">
                    <img id="logoImage" src="planpilot.png" alt="PlanPilot Logo" onerror="showLogoFallback()">
                </div>
                <h1>
                    <span>PlanPilot</span>
                    <button class="info-btn" onclick="openInfoModal()" title="Format Information">i</button>
                </h1>
                <p>Plan your perfect getaway</p>
            </div>
            
            <div class="sidebar-action-buttons">
                <button class="btn btn-primary" onclick="openPlanningModal()" style="margin-bottom: 10px;">
                    üöÄ Start Planning
                </button>
                
                <button class="btn btn-secondary" onclick="toggleTripSummary()" style="margin-bottom: 15px;">
                    üìã Trip Itinerary
                </button>

                <div style="display: flex; gap: 10px;">
                    <button class="btn btn-secondary" onclick="exportData()" style="flex: 1;">üíæ Save</button>
                    <button class="btn btn-secondary" onclick="importData()" style="flex: 1;">üìÇ Load</button>
                </div>
                
                <button class="btn btn-danger" id="clearAllBtn" onclick="clearAll()" style="margin-top: 15px;">
                    üóëÔ∏è Clear All
                </button>
            </div>
        </div>
    </div>

    <!-- Map Container -->
    <div id="map">
        <div id="mapTitle" class="map-title" onclick="toggleTripSummary()"></div>
    </div>

    <!-- Trip Summary Panel -->
    <div id="trip-summary-container" class="trip-summary-container">
        <div class="trip-summary-header">
            <h3>üó∫Ô∏è Trip Itinerary</h3>
            <div class="trip-summary-header-actions">
                <button id="trip-summary-edit-btn" class="trip-summary-edit-btn" onclick="toggleEditMode()" title="Edit Trip">
                    <span id="editModeIcon">‚úèÔ∏è</span>
                </button>
                <button id="trip-summary-close" class="trip-summary-close" onclick="toggleTripSummary()">‚úï</button>
            </div>
        </div>
        <div id="editTripContainer" class="trip-summary-edit-container" style="display: none;">
            <div class="control-group">
                <label for="tripTitle">Trip Title</label>
                <input type="text" id="tripTitle" placeholder="e.g., Sri Lanka Honeymoon" oninput="updateTripTitle()">
                <small>This title will display on your map</small>
            </div>

            <div id="connectionMode" class="connection-mode" style="display: none;">
                <p><strong>Connection Mode Active</strong><br>Click on two Key Locations to connect them with a line.</p>
                <button class="btn btn-secondary" onclick="cancelConnectionMode()">Cancel</button>
            </div>

            <div class="control-group">
                <label for="locationType">Location Type</label>
                <select id="locationType">
                    <option value="key-location">Key Location</option>
                    <option value="accommodation">Accommodation</option>
                    <option value="attraction">Attraction</option>
                </select>
            </div>

            <div class="control-group">
                <label for="locationName">Name</label>
                <input type="text" id="locationName" placeholder="e.g., Eiffel Tower">
            </div>

            <div class="control-group">
                <label for="locationDescription">Description (Optional)</label>
                <textarea id="locationDescription" placeholder="Add notes about this location..."></textarea>
            </div>

            <div class="control-group">
                <label for="locationPrice">Price (Optional)</label>
                <input type="text" id="locationPrice" placeholder="e.g., $150/night or ‚Ç¨25 entry">
            </div>

            <div class="control-group">
                <label for="locationLink">Link (Optional)</label>
                <input type="url" id="locationLink" placeholder="https://example.com/booking">
                <small>Website, booking link, or reference URL</small>
            </div>

            <div class="control-group">
                <label for="locationCoords">Coordinates</label>
                <input type="text" id="locationCoords" placeholder="Click on map or enter lat, lng" readonly>
                <small>Click anywhere on the map to set coordinates</small>
            </div>

            <div class="trip-summary-edit-actions">
                <button class="btn btn-primary" onclick="addLocation()">Add to Map</button>
                <button class="btn btn-secondary" onclick="startConnectionMode()">Connect Key Locations</button>
            </div>
        </div>
        <div class="trip-summary-body">
            <!-- Content generated dynamically by trip-summary.js -->
        </div>
    </div>

    <!-- Map Controls Toggle Button -->
    <button id="map-controls-toggle-btn" class="map-controls-toggle-btn" onclick="toggleMapControls()">
        üó∫Ô∏è Map Controls
    </button>

    <!-- Map Controls Panel -->
    <div id="map-controls-panel" class="map-controls-panel">
        <div class="map-controls-header">
            <h4>üó∫Ô∏è Map Controls</h4>
            <button class="map-controls-close" onclick="toggleMapControls()">‚úï</button>
        </div>
        
        <div class="map-controls-section">
            <h5>Map Style</h5>
            <div class="map-style-options">
                <div class="map-style-option" onclick="changeMapStyle('light')">
                    <input type="radio" name="mapStyle" id="styleLight" value="light" checked>
                    <label for="styleLight">‚òÄÔ∏è Light</label>
                </div>
                <div class="map-style-option" onclick="changeMapStyle('street')">
                    <input type="radio" name="mapStyle" id="styleStreet" value="street">
                    <label for="styleStreet">üó∫Ô∏è Street</label>
                </div>
                <div class="map-style-option" onclick="changeMapStyle('satellite')">
                    <input type="radio" name="mapStyle" id="styleSatellite" value="satellite">
                    <label for="styleSatellite">üõ∞Ô∏è Satellite</label>
                </div>
                <div class="map-style-option" onclick="changeMapStyle('topo')">
                    <input type="radio" name="mapStyle" id="styleTopo" value="topo">
                    <label for="styleTopo">‚õ∞Ô∏è Topographic</label>
                </div>
                <div class="map-style-option" onclick="changeMapStyle('dark')">
                    <input type="radio" name="mapStyle" id="styleDark" value="dark">
                    <label for="styleDark">üåô Dark</label>
                </div>
            </div>
        </div>

        <div class="map-controls-section">
            <h5>üîç Show/Hide Locations</h5>
            <div class="filter-item" onclick="toggleFilter('filterKeyLocation')">
                <input type="checkbox" id="filterKeyLocation" checked onchange="applyFilters()" onclick="event.stopPropagation()">
                <div class="legend-color key-location">üìç</div>
                <label for="filterKeyLocation">
                    <span>Key Locations</span>
                    <span class="filter-item-count" id="countKeyLocation">0</span>
                </label>
            </div>
            <div class="filter-item" onclick="toggleFilter('filterAccommodation')">
                <input type="checkbox" id="filterAccommodation" checked onchange="applyFilters()" onclick="event.stopPropagation()">
                <div class="legend-color accommodation">üè®</div>
                <label for="filterAccommodation">
                    <span>Accommodation</span>
                    <span class="filter-item-count" id="countAccommodation">0</span>
                </label>
            </div>
            <div class="filter-item" onclick="toggleFilter('filterAttraction')">
                <input type="checkbox" id="filterAttraction" checked onchange="applyFilters()" onclick="event.stopPropagation()">
                <div class="legend-color attraction">‚≠ê</div>
                <label for="filterAttraction">
                    <span>Attractions</span>
                    <span class="filter-item-count" id="countAttraction">0</span>
                </label>
            </div>
        </div>
    </div>

    <!-- Import Modal -->
    <div id="importModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>üìÇ Load Data</h2>
            </div>
            <div class="modal-body">
                <div class="control-group">
                    <label>Option 1: Select JSON File</label>
                    <input type="file" id="importFile" accept=".json" style="margin-bottom: 10px;" onchange="clearImportText()">
                    <small>Choose a .json file from your computer</small>
                </div>
                <div style="text-align: center; margin: 15px 0; color: var(--text-muted);">‚Äî OR ‚Äî</div>
                <div class="control-group">
                    <label for="importText">Option 2: Paste JSON Data</label>
                    <textarea id="importText" style="min-height: 150px;" oninput="clearImportFile()"></textarea>
                </div>
            </div>
            <div class="modal-actions">
                <button class="btn btn-primary" onclick="processImport()">Load</button>
                <button class="btn btn-secondary" onclick="closeImportModal()">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Confirm Modal -->
    <div id="confirmModal" class="modal">
        <div class="modal-content" style="max-width: 400px;">
            <div class="modal-header">
                <h2 id="confirmTitle">‚ö†Ô∏è Confirm Action</h2>
            </div>
            <div class="modal-body">
                <p id="confirmMessage" style="font-size: 14px; color: var(--text-primary); line-height: 1.6;"></p>
            </div>
            <div class="modal-actions">
                <button class="btn btn-primary" id="confirmYes">Yes, Continue</button>
                <button class="btn btn-secondary" id="confirmNo">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Alert Modal -->
    <div id="alertModal" class="modal">
        <div class="modal-content" style="max-width: 400px;">
            <div class="modal-header">
                <h2 id="alertTitle">‚ÑπÔ∏è Information</h2>
            </div>
            <div class="modal-body">
                <p id="alertMessage" style="font-size: 14px; color: var(--text-primary); line-height: 1.6; white-space: pre-line;"></p>
            </div>
            <div class="modal-actions">
                <button class="btn btn-primary" id="alertOk">OK</button>
            </div>
        </div>
    </div>

    <!-- Planning Modal -->
    <div id="planningModal" class="modal">
        <div class="modal-content" style="max-width: 550px;">
            <div class="modal-header">
                <h2>üöÄ Plan Your Trip</h2>
            </div>
            <div class="modal-body">
                <p style="font-size: 14px; color: #555; margin-bottom: 20px;">
                    Tell us about your trip and our AI will research and generate a complete itinerary for you!
                </p>
                
                <form id="tripPlanningForm" onsubmit="handlePlanningFormSubmit(event)">
                    <div class="control-group">
                        <label for="planDestination">Destination *</label>
                        <input type="text" id="planDestination" required placeholder="e.g., Paris, France">
                    </div>
                    
                    <div class="control-group">
                        <label for="planDuration">Trip Duration *</label>
                        <input type="text" id="planDuration" required placeholder="e.g., 5 days, 1 week">
                    </div>
                    
                    <div class="control-group">
                        <label for="planBudget">Budget Level</label>
                        <select id="planBudget">
                            <option value="">Select budget (optional)</option>
                            <option value="budget">Budget-friendly</option>
                            <option value="mid-range">Mid-range</option>
                            <option value="luxury">Luxury</option>
                        </select>
                    </div>
                    
                    <div class="control-group">
                        <label for="planResponseMode">AI Response Mode</label>
                        <select id="planResponseMode">
                            <option value="flash">‚ö° Quick & Light (5-15 seconds, fewer options)</option>
                            <option value="pro">üéØ Slow & Detailed (15-30 seconds, more options)</option>
                        </select>
                        <small style="font-style: italic;">
                            Quick mode is faster and cheaper. Detailed mode searches more thoroughly and provides more accommodation and attraction options.
                        </small>
                    </div>
                    
                    <div class="control-group">
                        <label for="planInterests">Interests (comma-separated)</label>
                        <input type="text" id="planInterests" placeholder="e.g., art, food, history, beaches">
                    </div>
                    
                    <div class="control-group">
                        <label for="planMustVisit">Must-Visit Locations</label>
                        <textarea id="planMustVisit" rows="2" placeholder="Specific places you want to include (optional)"></textarea>
                    </div>
                    
                    <div class="note" style="margin-top: 15px; font-size: 12px;">
                        <strong>‚ú® Note:</strong> The AI will research accommodations, attractions, prices, and coordinates to create your complete trip plan.
                    </div>
                </form>
            </div>
            <div class="modal-actions">
                <button type="submit" form="tripPlanningForm" class="btn btn-primary">
                    ‚ú® Generate Trip Plan
                </button>
                <button class="btn btn-secondary" onclick="closePlanningModal()">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay">
        <div class="loading-content">
            <div class="spinner"></div>
            <h3 id="loadingTitle">Generating Your Trip Plan...</h3>
            <p id="loadingMessage">Researching destinations and gathering information</p>
            <div class="progress-container">
                <div class="progress-bar" id="progressBar"></div>
            </div>
        </div>
    </div>

    <!-- Info Modal -->
    <div id="infoModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>üìã JSON Format Guide</h2>
            </div>
            <div class="modal-body">
                <div style="padding: 0 0 15px 0; margin: -10px -10px 20px -10px; border-bottom: 2px solid var(--border-color);">
                    <button class="btn btn-secondary" onclick="copyGuideToClipboard(event)" style="width: 100%; margin: 0;">üìã Copy Guide for AI</button>
                    <p style="margin: 10px 0 0 0; font-size: 12px; color: var(--text-secondary); text-align: center;">Copy this guide to your clipboard and paste it into an AI assistant to generate custom JSON files</p>
                </div>
                <div class="info-content">
                    <p>Use this guide to create or import location data for the PlanPilot. This format is designed for easy data entry and AI agent integration.</p>
                    
                    <h3>Required JSON Structure</h3>
                    <p>The JSON file must contain a <code>locations</code> array and optionally trip metadata and <code>connections</code>:</p>
                    
                    <pre>{
  "title": "Your Trip Name",
  "arrival_location": "Starting point",
  "departure_location": "Ending point",
  "locations": [ ... ],
  "connections": [ ... ]
}</pre>

                    <h3>Trip Metadata (Optional)</h3>
                    <ul>
                        <li><code>title</code> (string, optional): The name of your trip or holiday. Displayed at the top center of the map. Example: "Sri Lanka Honeymoon", "European Adventure 2025"</li>
                        <li><code>arrival_location</code> (string, optional): Where your journey begins (e.g., "London Heathrow Airport", "New York City"). Shows in Trip Summary as travel starting point.</li>
                        <li><code>departure_location</code> (string, optional): Where your journey ends (e.g., "Paris CDG Airport", "Rome"). Shows in Trip Summary as travel ending point.</li>
                    </ul>

                    <h3>Location Object Format</h3>
                    <p>Each location in the <code>locations</code> array must have the following properties:</p>
                    
                    <ul>
                        <li><code>id</code> (string, required): Unique identifier for the location</li>
                        <li><code>type</code> (string, required): Must be one of:
                            <ul>
                                <li><code>"key-location"</code> - Major destinations (purple markers)</li>
                                <li><code>"accommodation"</code> - Hotels, rentals (green markers)</li>
                                <li><code>"attraction"</code> - Places to visit (red markers)</li>
                            </ul>
                        </li>
                        <li><code>name</code> (string, required): Display name of the location</li>
                        <li><code>description</code> (string, optional): Additional notes or details</li>
                        <li><code>price</code> (string, optional): Cost information (e.g., "$150/night", "‚Ç¨25 entry")</li>
                        <li><code>link</code> (string, optional): URL for booking, website, or reference</li>
                        <li><code>lat</code> (number, required): Latitude coordinate (-90 to 90)</li>
                        <li><code>lng</code> (number, required): Longitude coordinate (-180 to 180)</li>
                    </ul>

                    <h3>Connection Object Format</h3>
                    <p>Each connection in the <code>connections</code> array connects two Key Locations:</p>
                    
                    <ul>
                        <li><code>id</code> (string, required): Unique identifier (typically "fromId-toId")</li>
                        <li><code>from</code> (string, required): ID of the first Key Location</li>
                        <li><code>to</code> (string, required): ID of the second Key Location</li>
                    </ul>

                    <div class="note">
                        <strong>‚ö†Ô∏è Note:</strong> Connections only work between locations with type <code>"key-location"</code>. Make sure both <code>from</code> and <code>to</code> reference valid Key Location IDs.
                    </div>

                    <h3>Complete Example</h3>
                    <pre>{
  "title": "Paris & Rome Adventure",
  "arrival_location": "London Heathrow Airport",
  "departure_location": "Rome Fiumicino Airport",
  "locations": [
    {
      "id": "1",
      "type": "key-location",
      "name": "Paris",
      "description": "City of Light, arrival point",
      "price": "",
      "link": "",
      "lat": 48.8566,
      "lng": 2.3522,
      "order": 1,
      "duration": "3 days"
    },
    {
      "id": "2",
      "type": "accommodation",
      "name": "Hotel de Paris",
      "description": "5-star hotel near Eiffel Tower",
      "price": "$250/night",
      "link": "https://booking.com/hotel-de-paris",
      "lat": 48.8584,
      "lng": 2.2945,
      "order": 2,
      "duration": "3 nights"
    },
    {
      "id": "3",
      "type": "attraction",
      "name": "Louvre Museum",
      "description": "World's largest art museum",
      "price": "‚Ç¨17 entry",
      "link": "https://louvre.fr",
      "lat": 48.8606,
      "lng": 2.3376,
      "order": 3,
      "duration": "3 hours"
    },
    {
      "id": "4",
      "type": "key-location",
      "name": "Rome",
      "description": "Next destination",
      "price": "",
      "link": "",
      "lat": 41.9028,
      "lng": 12.4964,
      "order": 4,
      "duration": "4 days"
    }
  ],
  "connections": [
    {
      "id": "1-4",
      "from": "1",
      "to": "4"
    }
  ]
}</pre>

                    <h3>AI Agent Instructions</h3>
                    <p>When creating a JSON file for this PlanPilot:</p>
                    <ol>
                        <li>Add a descriptive <code>title</code> field that summarizes the trip (e.g., "Sri Lanka Honeymoon", "Summer Europe Tour 2025")</li>
                        <li>Ensure all required fields are present for each location</li>
                        <li>Add <code>order</code> field (number) to sequence locations chronologically (1, 2, 3, etc.)</li>
                        <li>Add <code>duration</code> field (string) for stay length: "3 days" for cities, "2 nights" for hotels, "2 hours" for attractions</li>
                        <li>Use consistent ID formats (strings, unique)</li>
                        <li>Verify coordinates are valid (use geocoding if needed)</li>
                        <li>Only create connections between <code>"key-location"</code> types</li>
                        <li>Include helpful descriptions to provide context</li>
                        <li>Add price and link information where relevant for accommodation and attractions</li>
                        <li>Validate JSON syntax before importing</li>
                    </ol>
                </div>
            </div>
            <div class="modal-actions">
                <button class="btn btn-primary" onclick="closeInfoModal()">Got it!</button>
            </div>
        </div>
    </div>

    <!-- Location Details Modal -->
    <div id="locationDetailsModal" class="modal">
        <div class="modal-content" style="max-width: 900px;">
            <div class="modal-header">
                <h2 id="locationDetailsTitle">üìç Location Details</h2>
            </div>
            <div class="modal-body">
                <div id="locationDetailsContent">
                    <!-- Content will be populated by JavaScript -->
                </div>
            </div>
            <div class="modal-actions">
                <button class="btn btn-primary" onclick="closeLocationDetailsModal()">Close</button>
            </div>
        </div>
    </div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <!-- PlanPilot JS (ES6 Module) -->
    <script type="module" src="js/app.js"></script>
</body>
</html>
